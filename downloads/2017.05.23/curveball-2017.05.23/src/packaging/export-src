#!/bin/bash
#
# This material is based upon work supported by the Defense Advanced
# Research Projects Agency under Contract No. N66001-11-C-4017 and in
# part by a grant from the United States Department of State.
# The opinions, findings, and conclusions stated herein are those
# of the authors and do not necessarily reflect those of the United
# States Department of State.
#
# Copyright 2014-2016 - Raytheon BBN Technologies Corp.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied.  See the License for the specific language governing
# permissions and limitations under the License.

# Make a gzip'd tarball of the source for everything needed to create
# the Ubuntu 12.04 .deb package.  Also includes the source needed
# other platforms, except maybe some of the Android source.
#
# The name of the tarball is curveball-$VERSION.tgz, where $VERSION
# is generated by the create-version script (*not* the VERSION file
# in the current directory).  The VERSION file within the tarball is
# created to match this VERSION.
#
# Eventually we'll want to be able to do this from the HEAD of master,
# the HEAD of another branch, a tag, or a commit, etc.  For today, we
# just do it from whatever is checked out in the current directory.

PROJNAME=curveball

# Just grab the first 16 characters of the hashcode for the current commit.
# (If this commit isn't ever pushed, then it may become irreproducible)
#
HASHCODE=$(git log | head -1 | awk '{print $2}' \
	| sed -e 's/^\(.\{16\}\).*$/\1/')

DATESTR=$(date +"%Y%m%d-%H%M")

SCRIPTDIR=$(/usr/bin/dirname $(/usr/bin/which "$0"))
DESCRIBE_BUILD_TOOL=${SCRIPTDIR}/describe-build

# Use create-version when making a directory; use create-version
# to make a date-based string that makes sense for exports.
#
VERSION=$("${SCRIPTDIR}"/create-version)

if [ -d "${TARGETDIR}" ]; then
    rm -rf "${TARGETDIR}"
    if [ $? -ne 0 ]; then
	echo "ERROR: cannot remove ${TARGETDIR}"
	exit 1
    fi
fi

# Run in the parent of the packaging directory, so that we fetch
# all of src.
#
BUILD_INFO=$($DESCRIBE_BUILD_TOOL)

cd "${SCRIPTDIR}/.."

DIRNAME="${PROJNAME}-${VERSION}"
BASEDIR="${HOME}/tmp"
TARGETDIR="${BASEDIR}/${DIRNAME}"

# If the target directory already exists, it's probably filled
# with stuff from a previous build.  Nuke it.
#
sudo /bin/rm -rf "${TARGETDIR}/"

git checkout-index -a -f --prefix="${TARGETDIR}/"

ROOT="${TARGETDIR}/src"

# Remove parts of the source tree that are unnecessary
# for building the essential Curveball client and servers
#
for dir in \
	C android attic bitarray BitTornado ears firefox grazer \
	openssl packetplay sentinels transmission trawler web-test \
	deter demo ; do
    echo "Omitting $dir"
    rm -rf "${ROOT}/${dir}"
done

for tarball in \
	click/click-09222011.tar.gz \
	click/click-08072012.tar.gz \
	click/click-01072013.tar.gz \
	click/click-01102014.tar.gz \
	click/click-01102014cb.tar.gz \
	nss/nss-3.13.3/nss-3.13.3.tar.gz ; do
    echo "Omitting $tarball"
    rm -rf "${ROOT}/${tarball}"
done

# remove old fastclick tarballs that we don't use any more
for tarball in \
	fastclick-20160726.tgz  fastclick-20160901.tgz \
	fastclick-20160810.tgz  fastclick-20161005.tgz \
	fastclick-20160824.tgz  fastclick-20161019.tgz \
	; do
    rm -f "${ROOT}/dependencies/$tarball"
done

for extra in \
	bbn-tools/ \
	nss/python-nss-0.11 python/cb/trawl \
	python/socksipy python/tests \
	tests/stress-client \
	sentinels/keys docs/OLD \
	python/cb/ct/http/DECOY_HOSTS.txt \
	python/cb/ct/http/good-http.txt \
	python/cb/ct/http/MULTIFLOW.txt \
	python/cb/ct/httpuni/unidirectional-mole-code-changes.txt \
	docs/assessment-2014 docs/bittorrent docs/ICMPTaxonomy.txt \
	python/cb/twisted \
	.project .pydevproject \
	client-u10.mk client-u12.mk \
	; do

    echo "Omitting $extra"
    rm -rf "${ROOT}/${extra}"
done

# Leave the amazon host certs out
rm -rf "${ROOT}/CA/CERTS/"*compute-1.amazonaws.com.???
# Omit the experiments, because they're broken
rm -rf "${ROOT}/experiments"

# The scripts directory is filled with many obsolete files.
# Move everything into an "old-scripts" directory and then
# move only the essential scripts back.
#
mv "${ROOT}/scripts" "${ROOT}/old-scripts"
mkdir "${ROOT}/scripts"

for script in \
    cbnoc-bdh-setup cb-cleanup-dr cb-install cbnoc-key-setup \
    cbnoc-keymanager \
    cbnoc-dhblacklist cb-noc-create-sentinel-files cb-noc-cleanup \
    cb-shutdown cb-startup-testbed curveball-key-config curveball-client \
    curveball-key-change decoyproxy.conf cb-dp cb-dr \
    decoyproxy0.conf decoyproxy1.conf decoyproxy2.conf decoyproxy3.conf \
    write-click-config \
    cb-dr-combo \
    curveball-install-test-ca-cert cb-install-test-node-cert \
    mini-httpd \
    curveball-my-conns curveball-pin-route \
    cbnoc-push-baddh-rem cbnoc-push-baddh-loc \
    cbnoc-push-sentinels-rem cbnoc-push-sentinels-loc \
    curveball-vpn-subnet curveball-cbsm \
    remora-client remora-server remora-shutdown \
    quilt-client quilt-server \
    build-fastclick.sh setup-dell-ixgbe.sh \
    bridge-util unset-ips \
    cb-noc-cron cb-noc-rm-old \
    ;
do
    mv "${ROOT}/old-scripts/${script}" "${ROOT}/scripts"
done
rm -rf "${ROOT}/old-scripts"

# Replace the internal Makefile with BBN flags with
# the generic Makefile
#
cp "${ROOT}/click/Makefile.deb" "${ROOT}/click/Makefile"

# Set up the build-info and VERSION files in the exported directory,
# and update the _VERSION_ placeholder in the docs.
#
echo "${BUILD_INFO}" > "${ROOT}"/build-info.txt
echo "${VERSION}" > "${ROOT}"/packaging/VERSION

for doc in ${ROOT}/docs/*.htm ${ROOT}/docs/*.txt ; do
    cat "${doc}" | sed -e "s/_VERSION_/$VERSION/g" > "${doc}.tmp"
    mv "${doc}.tmp" "${doc}"
done

( cd "${BASEDIR}" ; tar zcf "${DIRNAME}.tgz" "${DIRNAME}" )

# Now that we're done with the directory, remove it
# (and keep the tarball)

rm -rf "${TARGETDIR}"
